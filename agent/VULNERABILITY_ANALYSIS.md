# Vulnerability Analysis: Agent Disconnection Issues

## Critical Vulnerabilities Found

### 1. **CRITICAL: No Registration Confirmation Wait**
**Location:** `Program.cs:274-286`

**Issue:** After sending the registration message, the code immediately checks if the WebSocket is open and returns `true`, but never waits for or checks a confirmation response from the gateway.

**Impact:** If the gateway rejects the registration (invalid role, parsing error, etc.), the agent won't know and will start listening. The gateway may then close the connection when it receives messages from an unregistered client.

**Code:**
```csharp
// Register as "agent" role with Gateway
string registerMessage = "{\"type\":\"register\",\"role\":\"agent\"}";
byte[] registerBytes = Encoding.UTF8.GetBytes(registerMessage);
using (var sendCts = new CancellationTokenSource(TimeSpan.FromSeconds(5)))
{
    await GatewayWebSocket.SendAsync(...);
}

return GatewayWebSocket.State == WebSocketState.Open; // ❌ No confirmation check!
```

**Fix:** Wait for a registration confirmation message from the gateway before proceeding.

---

### 2. **CRITICAL: Race Condition - Messages Before Registration Complete**
**Location:** `server.cs:216-288`

**Issue:** The `StartListeningAsync` method starts immediately after connection, but there's no guarantee that registration has been processed by the gateway. If the gateway sends a message before registration completes, or if registration fails, the agent will try to process it as a command.

**Impact:** The gateway may send an error or close the connection if it receives messages from an unregistered client (see `gateway/src/server.js:78-80`).

**Fix:** Ensure registration is confirmed before starting the listener loop.

---

### 3. **CRITICAL: JsonDocument Memory Leak**
**Location:** `server.cs:52`

**Issue:** `JsonDocument.Parse()` creates a `JsonDocument` that implements `IDisposable`, but it's never disposed. This causes a memory leak and can lead to resource exhaustion.

**Code:**
```csharp
var message = JsonDocument.Parse(messageJson); // ❌ Never disposed!
var root = message.RootElement;
```

**Impact:** Memory leaks accumulate over time, potentially causing the application to crash or disconnect.

**Fix:** Use `using` statement or manually dispose:
```csharp
using (var message = JsonDocument.Parse(messageJson))
{
    var root = message.RootElement;
    // ... rest of code
}
```

---

### 4. **HIGH: Keepalive Task Not Awaited**
**Location:** `server.cs:222`

**Issue:** The keepalive task is started with `Task.Run()` but never awaited. If it fails immediately (e.g., WebSocket already closed), the exception won't be caught.

**Code:**
```csharp
var keepaliveTask = Task.Run(async () => await KeepaliveLoopAsync(cancellationTokenSource.Token));
// ❌ Task is fire-and-forget, exceptions are swallowed
```

**Impact:** Silent failures in keepalive could lead to connection timeouts without proper error reporting.

**Fix:** Store the task and handle exceptions, or use proper task continuation.

---

### 5. **MEDIUM: Binary Message Handling Issue**
**Location:** `server.cs:260-264`

**Issue:** When a binary message is received, the code logs a warning and continues, but doesn't properly handle the message state. The `result.EndOfMessage` check in the `while` loop might not work correctly for binary messages.

**Code:**
```csharp
else if (result.MessageType == WebSocketMessageType.Binary)
{
    Console.WriteLine("[WARNING] Received binary message, ignoring");
    continue; // ❌ May skip message fragment handling
}
```

**Impact:** If binary messages are fragmented, the loop might get stuck or skip fragments incorrectly.

---

### 6. **MEDIUM: No Timeout on Registration Send**
**Location:** `Program.cs:277-284`

**Issue:** While there's a 5-second timeout for sending the registration message, if the send succeeds but the gateway is slow to process it, the agent proceeds without confirmation.

**Impact:** Timing issues could cause the agent to start before the gateway finishes registration.

---

### 7. **LOW: Keepalive Sends Text Instead of Ping Frame**
**Location:** `server.cs:362-367`

**Issue:** The keepalive sends a text message "ping" instead of a proper WebSocket ping frame. While the gateway accepts this (see `gateway/src/server.js:51`), it's not the standard WebSocket way.

**Impact:** Minor - works but not optimal. Could cause issues with some WebSocket implementations.

---

## Recommended Fixes Priority

1. **IMMEDIATE:** Add registration confirmation wait
2. **IMMEDIATE:** Fix JsonDocument disposal
3. **HIGH:** Ensure registration completes before starting listener
4. **MEDIUM:** Properly handle keepalive task exceptions
5. **LOW:** Improve binary message handling

---

## Most Likely Cause of Disconnection

Based on the analysis, the **most likely cause** is **Issue #1 and #2 combined**:

1. Agent connects and sends registration
2. Agent immediately starts listening without waiting for confirmation
3. Gateway either:
   - Hasn't processed registration yet, OR
   - Rejected registration silently
4. Gateway receives messages/routing attempts from unregistered client
5. Gateway closes connection (or agent sends message that triggers error)

The gateway code shows that unregistered clients trigger error logs, and the connection may be closed by the gateway or network timeout.

